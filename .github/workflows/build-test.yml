- name: Verify anonymization
  run: |
    python << 'EOF'
    import sqlite3, os

    db_path = os.getenv('DATABASE_PATH', '/data/test_users.db')
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    cursor.execute("SELECT id, name, email FROM users")
    rows = cursor.fetchall()

    errors = []

    for user_id, name, email in rows:
        expected_email = f"anonym_{user_id}@example.com"
        
        if name != "Anonym AnvÃ¤ndare":
            errors.append(f"Name not anonymized for user {user_id}: {name}")

        if email != expected_email:
            errors.append(f"Email not anonymized correctly for user {user_id}: {email} != {expected_email}")

    if errors:
        print("\n".join(errors))
        raise SystemExit("Anonymization test FAILED")

    print("Anonymization test PASSED: All users anonymized correctly")
    conn.close()
    EOF
